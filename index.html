<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©rateur Newsletter TourMaG (corrig√©)</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Segoe UI, sans-serif; background:linear-gradient(135deg,#667eea,#764ba2); padding:20px; min-height:100vh; }
    .container { max-width:1200px; margin:auto; background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; }
    .header { background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:40px; text-align:center; }
    .header h1 { font-size:2.5em; margin-bottom:10px; text-shadow:2px 2px 4px rgba(0,0,0,0.2); }
    .content { padding:40px; }
    textarea,input { width:100%; border:2px solid #ddd; border-radius:10px; padding:10px; font-family:monospace; }
    button { padding:12px 25px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; }
    .btn-primary { background:linear-gradient(135deg,#667eea,#764ba2); color:white; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ G√©n√©rateur Newsletter TourMaG (corrig√©)</h1>
      <p>Nettoyage du Poddle, largeur ajust√©e, centrage des images</p>
    </div>
    <div class="content">
      <textarea id="newsletter-template" rows="10" placeholder="Collez votre template ici..."></textarea><br><br>
      <input id="focus-url-input" placeholder="URL Focus (Article 2)" /><br><br>
      <input id="url-input" placeholder="URLs Articles (s√©par√©es par des retours √† la ligne)" /><br><br>
      <button class="btn-primary" id="generate-btn" onclick="generateNewsletter()">üéØ G√©n√©rer</button>
      <div id="result-container" style="margin-top:20px;display:none;">
        <textarea id="result-textarea" rows="15" readonly></textarea>
      </div>
    </div>
  </div>

<script>
async function generateNewsletter() {
  const tpl = document.getElementById('newsletter-template').value;
  if (!tpl) return alert('Veuillez coller un template HTML.');

  const focusUrl = document.getElementById('focus-url-input').value.trim();
  const urls = document.getElementById('url-input').value.split(/\n+/).map(u=>u.trim()).filter(u=>u);
  const all = focusUrl ? [focusUrl, ...urls] : urls;

  const res = await fetch('/api/scrape', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ urls: all })
  });
  const data = await res.json();

  // Nettoyage automatique du Poddle et HTML dans le chap√¥
  const articles = data.articles.map(a => ({
    ...a,
    chapo: a.chapo
      .replace(/<script[\s\S]*?<\/script>/gi, '')
      .replace(/PodlePlayer\.init[\s\S]*?;/gi, '')
      .replace(/<\/?[^>]+(>|$)/g, '')
      .replace(/&nbsp;/g, ' ')
      .trim()
  }));

  let html = tpl;
  if (focusUrl && articles.length) html = replaceFocusBlock(tpl, articles[0]);

  document.getElementById('result-textarea').value = html;
  document.getElementById('result-container').style.display = 'block';
}

// Bloc focus width=100% et image centr√©e
function replaceFocusBlock(template, article) {
  const start = template.indexOf('<!--DEBUT ARTICLE 2-->');
  const end = template.indexOf('<!--FIN ARTICLE 2-->', start);
  if (start === -1 || end === -1) return template;
  const before = template.substring(0, start);
  const after = template.substring(end + '<!--FIN ARTICLE 2-->'.length);
  const focusHTML = `<!--DEBUT ARTICLE 2-->
  <tr><td>
  <table width="100%" align="center" style="max-width:700px;background:#fff;margin:0 auto;">
  <tr>
  <td width="9"></td>
  <td width="335" align="center">
    <a href="${article.url}" target="_blank">
      <img src="${article.image}" alt="${article.alt}" width="335" height="276" style="display:block;margin:0 auto;">
    </a>
  </td>
  <td width="14"></td>
  <td width="326" style="font-family:arial,sans-serif;font-size:16px;color:#61666d;vertical-align:top;">
    <span style="color:#579CFD;font-size:25px;">FOCUS</span><br>
    <a href="${article.url}" target="_blank" style="color:#325867;text-decoration:none;font-size:20px;font-weight:bold;">${article.title}</a><br>
    ${article.chapo}
  </td>
  <td width="9"></td>
  </tr></table></td></tr><tr><td height="40">&nbsp;</td></tr><!--FIN ARTICLE 2-->`;
  return before + focusHTML + after;
}
</script>
</body>
</html>
